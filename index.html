<!DOCTYPE html>
<html lang="pt-mz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MASTER ADMIN | Ultra</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg: #050505;
            --sidebar: #0f0f0f;
            --card: #141414;
            --primary: #29b6f6;
            --danger: #ef5350;
            --success: #00e676;
            --warning: #ffb74d;
            --text: #ffffff;
            --muted: #888;
            --border: rgba(255,255,255,0.08);
            --radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

        body { 
            background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; animation: fadeIn 0.8s ease;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInLeft { from { transform: translateX(-100%); } to { transform: translateX(0); } }

        #c-toast {
            position: fixed; top: 20px; right: 20px; background: #222; border: 1px solid var(--border);
            padding: 15px 25px; border-radius: 50px; transform: translateX(200%); transition: var(--transition); z-index: 9999;
            display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #c-toast.show { transform: translateX(0); }

        .custom-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 5000;
            display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: var(--transition);
            backdrop-filter: blur(5px);
        }
        .custom-modal.open { opacity: 1; pointer-events: all; }
        .modal-box {
            background: #181818; width: 95%; max-width: 400px; padding: 25px; border-radius: 16px;
            border: 1px solid var(--border); transform: scale(0.8); transition: var(--transition);
        }
        .custom-modal.open .modal-box { transform: scale(1); }

        aside { 
            width: 260px; background: var(--sidebar); border-right: 1px solid var(--border); 
            display: flex; flex-direction: column; padding: 25px; animation: slideInLeft 0.6s ease;
        }
        .brand { font-size: 1.4rem; font-weight: 800; color: #fff; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .brand span { color: var(--primary); }
        
        .nav-item { 
            padding: 14px 15px; color: var(--muted); text-decoration: none; border-radius: 10px; 
            margin-bottom: 5px; transition: var(--transition); cursor: pointer; display: flex; align-items: center; gap: 12px; font-weight: 500;
        }
        .nav-item:hover { background: rgba(255,255,255,0.03); color: #fff; transform: translateX(5px); }
        .nav-item.active { background: rgba(41, 182, 246, 0.1); color: var(--primary); font-weight: 700; }

        main { flex: 1; padding: 30px; overflow-y: auto; scroll-behavior: smooth; }
        
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { 
            background: var(--card); padding: 25px; border-radius: var(--radius); border: 1px solid var(--border); 
            transition: var(--transition); animation: slideUp 0.5s ease forwards;
        }
        .stat-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .stat-val { font-size: 1.8rem; font-weight: 700; color: #fff; margin-top: 10px; }
        .stat-title { color: var(--muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; }

        .chart-container { 
            background: var(--card); padding: 25px; border-radius: var(--radius); border: 1px solid var(--border); 
            height: 350px; width: 100%; margin-bottom: 25px; transition: var(--transition);
        }

        .content-card { 
            background: var(--card); padding: 25px; border-radius: var(--radius); border: 1px solid var(--border); 
            margin-bottom: 20px; animation: slideUp 0.4s ease; transition: var(--transition);
        }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-size: 0.8rem; color: var(--muted); }
        input, select, textarea { width: 100%; background: #080808; border: 1px solid var(--border); padding: 12px; border-radius: 8px; color: #fff; outline: none; transition: var(--transition); }
        input:focus, textarea:focus { border-color: var(--primary); background: #0c0c0c; }
        
        .btn { padding: 12px 20px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; transition: var(--transition); display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-primary:hover { filter: brightness(1.2); box-shadow: 0 0 15px rgba(41, 182, 246, 0.3); }
        .btn-danger { background: rgba(239, 83, 80, 0.1); color: var(--danger); }
        .btn-danger:hover { background: var(--danger); color: #fff; }
        .btn-success { background: rgba(0, 230, 118, 0.1); color: var(--success); }
        .btn-success:hover { background: var(--success); color: #000; }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: #fff; }
        .btn-ghost:hover { background: var(--border); }

        .table-responsive { overflow-x: auto; width: 100%; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; min-width: 600px; }
        th { text-align: left; padding: 15px; color: var(--muted); border-bottom: 1px solid var(--border); font-size: 0.75rem; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 0.9rem; transition: var(--transition); }
        tr:hover td { background: rgba(255,255,255,0.01); }
        
        .img-thumb { width: 45px; height: 45px; border-radius: 8px; object-fit: cover; background: #222; transition: 0.3s; }
        .img-thumb:hover { transform: scale(1.1); }

        /* Abas de Filtro */
        .filter-tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-btn { padding: 8px 16px; border-radius: 20px; background: #222; border: 1px solid var(--border); color: var(--muted); cursor: pointer; transition: 0.3s; font-size: 0.85rem; }
        .filter-btn.active { background: var(--primary); color: #000; font-weight: 700; border-color: var(--primary); }

        .hidden { display: none !important; }

        @media (max-width: 900px) {
            body { flex-direction: column; }
            aside { 
                width: 100%; height: auto; padding: 15px; border-right: none; border-bottom: 1px solid var(--border); 
                flex-direction: row; overflow-x: auto; position: sticky; top: 0; z-index: 1000;
            }
            .brand { margin-bottom: 0; margin-right: 20px; font-size: 1rem; }
            .nav-item { margin-bottom: 0; padding: 10px 15px; white-space: nowrap; font-size: 0.85rem; }
            main { padding: 20px; }
            .stat-val { font-size: 1.5rem; }
        }
    </style>
</head>
<body>

    <div id="c-toast"><i class="fa fa-info-circle"></i> <span>A√ß√£o realizada</span></div>

    <div id="confirmModal" class="custom-modal">
        <div class="modal-box" style="text-align: center;">
            <i class="fa fa-exclamation-triangle" style="font-size: 2.5rem; color: var(--danger); margin-bottom: 15px;"></i>
            <h3 style="color:#fff; margin-bottom: 10px;">Confirmar Exclus√£o?</h3>
            <p style="color:var(--muted); margin-bottom: 25px; font-size: 0.9rem;">Esta a√ß√£o n√£o poder√° ser desfeita.</p>
            <div style="display:flex; gap: 10px; justify-content: center;">
                <button class="btn btn-ghost" onclick="closeConfirm()">Cancelar</button>
                <button class="btn btn-danger" id="confirmBtnAction">Excluir Agora</button>
            </div>
        </div>
    </div>

    <aside>
        <div class="brand"><i class="fa fa-layer-group"></i> MASTER <span>ULTRA</span></div>
        <nav style="display: flex; flex-direction: inherit; gap: 5px;">
            <div class="nav-item active" onclick="nav('dash', this)"><i class="fa fa-chart-pie"></i> Dash</div>
            <div class="nav-item" onclick="nav('orders', this)"><i class="fa fa-shopping-bag"></i> Pedidos</div>
            <div class="nav-item" onclick="nav('users', this)"><i class="fa fa-users"></i> Clientes</div>
            <div class="nav-item" onclick="nav('prod', this)"><i class="fa fa-box-open"></i> Produtos</div>
            <div class="nav-item" onclick="nav('cat', this)"><i class="fa fa-tags"></i> Tags</div>
            <div class="nav-item" onclick="nav('banners', this)"><i class="fa fa-images"></i> Banners</div>
            <div class="nav-item" onclick="nav('content', this)"><i class="fa fa-cog"></i> Ajustes</div>
        </nav>
    </aside>

    <main>
        <div id="view-dash">
            <h2 style="margin-bottom: 25px;">Vis√£o Geral</h2>
            <div class="dashboard-grid">
                <div class="stat-card" style="animation-delay: 0.1s;">
                    <div class="stat-title">Faturamento (Pagos)</div>
                    <div class="stat-val" style="color:var(--success)" id="st-revenue">0 MT</div>
                </div>
                <div class="stat-card" style="animation-delay: 0.2s;">
                    <div class="stat-title">Pedidos Hoje</div>
                    <div class="stat-val" id="st-orders-today">0</div>
                </div>
                <div class="stat-card" style="animation-delay: 0.3s;">
                    <div class="stat-title">Pedidos Recusados</div>
                    <div class="stat-val" style="color:var(--danger)" id="st-orders-rej">0</div>
                </div>
                <div class="stat-card" style="animation-delay: 0.4s;">
                    <div class="stat-title">Total de Clientes</div>
                    <div class="stat-val" style="color:var(--warning)" id="st-users">0</div>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="salesChart"></canvas>
            </div>
        </div>

        <div id="view-orders" class="hidden">
            <h2 style="margin-bottom: 20px;">Gest√£o de Pedidos</h2>
            
            <div class="filter-tabs">
                <div class="filter-btn active" onclick="filterOrders('all', this)">Todos</div>
                <div class="filter-btn" onclick="filterOrders('pending', this)">Pendentes</div>
                <div class="filter-btn" onclick="filterOrders('completed', this)">Conclu√≠dos</div>
                <div class="filter-btn" onclick="filterOrders('rejected', this)">Recusados</div>
            </div>

            <div class="content-card">
                <div class="table-responsive">
                    <table>
                        <thead><tr><th>Data</th><th>Cliente</th><th>Itens</th><th>Total</th><th>Status</th><th>A√ß√µes</th></tr></thead>
                        <tbody id="tb-orders"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-users" class="hidden">
            <h2 style="margin-bottom: 20px;">Base de Clientes</h2>
            <div class="content-card">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                    <input oninput="filterUsers(this.value)" placeholder="üîç Buscar por nome ou email..." style="max-width: 300px;">
                </div>
                <div class="table-responsive">
                    <table>
                        <thead><tr><th>Nome</th><th>Email</th><th>Telefone</th><th>Local</th><th>A√ß√µes</th></tr></thead>
                        <tbody id="tb-users"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-prod" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap: wrap; gap:10px;">
                <h2>Produtos</h2>
                <button class="btn btn-primary" onclick="toggleForm('prodForm')"><i class="fa fa-plus"></i> Novo Produto</button>
            </div>

            <div id="prodForm" class="content-card hidden" style="border-left: 4px solid var(--primary);">
                <form id="f-prod">
                    <div class="form-grid">
                        <div><label>Nome do Produto</label><input id="pName" required placeholder="Ex: iPhone 15"></div>
                        <div><label>Pre√ßo (MT)</label><input id="pPrice" type="number" required></div>
                    </div>
                    <div class="form-grid">
                        <div><label>Categoria</label><select id="pCat"><option>Carregando...</option></select></div>
                        <div><label>Imagem Principal (URL)</label><input id="pImg1" required></div>
                        <div><label>Imagens Extras (URL)</label><input id="pImg2" placeholder="Opcional"></div>
                    </div>
                    <div class="form-grid">
                        <div><label>Tamanhos</label><input id="pSizes" placeholder="P, M, G"></div>
                        <div><label>Cores</label><input id="pColors" placeholder="Azul, Preto"></div>
                    </div>
                    <button type="submit" class="btn btn-primary">Salvar Produto</button>
                </form>
            </div>

            <div class="content-card">
                <input oninput="filterTable(this.value)" placeholder="üîç Buscar produto..." style="margin-bottom:15px; max-width: 400px;">
                <div class="table-responsive">
                    <table>
                        <thead><tr><th>Foto</th><th>Nome</th><th>Pre√ßo</th><th>Categ.</th><th>Excluir</th></tr></thead>
                        <tbody id="tb-prod"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-cat" class="hidden">
            <h2>Categorias</h2>
            <div class="content-card">
                <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap: wrap;">
                    <input id="catName" placeholder="Nome da Categoria" style="max-width: 300px;">
                    <button class="btn btn-primary" onclick="addCategory()">Adicionar</button>
                </div>
                <div id="cat-chips" style="display:flex; flex-wrap:wrap; gap:10px;"></div>
            </div>
        </div>

        <div id="view-banners" class="hidden">
            <h2>Banners da Loja</h2>
            <div class="content-card">
                <div class="form-grid">
                    <div><label>URL da M√≠dia (GIF/Imagem/V√≠deo)</label><input id="bUrl" placeholder="Link da imagem"></div>
                    <div><label>Tipo</label><select id="bType"><option value="image">Imagem</option><option value="video">V√≠deo</option></select></div>
                    <div><label>Link de Redirecionamento (Opcional)</label><input id="bLink" placeholder="Para onde vai ao clicar?"></div>
                </div>
                <button class="btn btn-primary" onclick="addBanner()">Adicionar Banner</button>
                
                <div id="banner-list" style="margin-top:20px; display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:15px;"></div>
            </div>
        </div>

        <div id="view-content" class="hidden">
            <h2>Gest√£o de Conte√∫do</h2>
            <div class="content-card">
                <h3 style="color:var(--primary); margin-bottom:15px; font-size: 1rem;">Links e Contato</h3>
                <div class="form-grid">
                    <div><label>WhatsApp</label><input id="cWa"></div>
                    <div><label>Telefone</label><input id="cPh"></div>
                    <div><label>Rede Social</label><input id="cSocial"></div>
                    <div><label>Logo URL</label><input id="cLogo"></div>
                </div>
                
                <div style="margin-top: 15px;">
                    <label style="color:var(--success)">Link de Download do App</label>
                    <input id="cAppLink" placeholder="Link da Play Store / Baixar APK">
                </div>

                <h3 style="color:var(--primary); margin:20px 0 15px; font-size: 1rem;">Textos da Loja</h3>
                <div class="form-grid" style="grid-template-columns: 1fr;">
                    <div>
                        <label>Sobre N√≥s</label>
                        <textarea id="cAbout" rows="3"></textarea>
                    </div>
                    <div>
                        <label>Informa√ß√µes de Entrega</label>
                        <textarea id="cDelivery" rows="3"></textarea>
                    </div>
                </div>

                <button class="btn btn-primary" style="margin-top:10px;" onclick="saveConfig()">Atualizar Loja</button>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, setDoc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAPKEeQwU3vsNqWyLjgb7czsk_8-wzPfPo",
            authDomain: "criador-6da7a.firebaseapp.com",
            projectId: "criador-6da7a",
            storageBucket: "criador-6da7a.firebasestorage.app",
            messagingSenderId: "227610191967",
            appId: "1:227610191967:web:40b9727ce93b655bbad3ea"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let productsList = [];
        let ordersList = [];
        let usersList = [];
        let salesChart = null;
        let currentOrderFilter = 'all';

        window.toast = (msg, type = 'success') => {
            const t = document.getElementById('c-toast');
            t.className = type; 
            t.innerHTML = `<i class="fa fa-${type === 'success' ? 'check' : 'exclamation'}-circle"></i> <span>${msg}</span>`;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        };

        let pendingDeleteAction = null;
        window.askDelete = (callback) => {
            pendingDeleteAction = callback;
            document.getElementById('confirmModal').classList.add('open');
        };
        document.getElementById('confirmBtnAction').onclick = () => {
            if(pendingDeleteAction) pendingDeleteAction();
            closeConfirm();
        };
        window.closeConfirm = () => {
            document.getElementById('confirmModal').classList.remove('open');
            pendingDeleteAction = null;
        };

        window.nav = (id, el) => {
            document.querySelectorAll('main > div').forEach(d => d.classList.add('hidden'));
            const target = document.getElementById('view-'+id);
            if(target) {
                target.classList.remove('hidden');
                target.style.animation = 'none';
                void target.offsetWidth; 
                target.style.animation = 'slideUp 0.4s ease';
            }
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
        };
        window.toggleForm = (id) => document.getElementById(id).classList.toggle('hidden');

        // --- Gr√°fico ---
        const initChart = (data) => {
            const ctx = document.getElementById('salesChart').getContext('2d');
            if(salesChart) salesChart.destroy();
            
            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: 'Vendas (MT)',
                        data: Object.values(data),
                        borderColor: '#29b6f6',
                        backgroundColor: 'rgba(41, 182, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#29b6f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#888' } },
                        x: { grid: { display: false }, ticks: { color: '#888' } }
                    }
                }
            });
        };

        // --- Pedidos ---
        window.filterOrders = (status, btn) => {
            currentOrderFilter = status;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderOrders();
        };

        const renderOrders = () => {
            let filtered = ordersList;
            if(currentOrderFilter !== 'all') {
                filtered = ordersList.filter(o => o.status === currentOrderFilter);
            }

            const rows = filtered.map(data => {
                const dateStr = new Date(data.date).toLocaleDateString();
                let statusBadge = '';
                if(data.status === 'completed') statusBadge = '<span class="status-badge" style="padding:4px 10px; border-radius:20px; font-size:0.75rem; background:rgba(0,230,118,0.1); color:#00e676">Conclu√≠do</span>';
                else if(data.status === 'rejected') statusBadge = '<span class="status-badge" style="padding:4px 10px; border-radius:20px; font-size:0.75rem; background:rgba(239,83,80,0.1); color:#ef5350">Recusado</span>';
                else statusBadge = '<span class="status-badge" style="padding:4px 10px; border-radius:20px; font-size:0.75rem; background:rgba(255,193,7,0.1); color:#ffc107">Pendente</span>';

                return `<tr>
                    <td>${dateStr}</td>
                    <td>${data.userName}</td>
                    <td>${data.items ? data.items.length : 0} itens</td>
                    <td>${(data.total || 0).toLocaleString()} MT</td>
                    <td>${statusBadge}</td>
                    <td style="display:flex; gap:5px;">
                        <button class="btn btn-success" style="padding:6px 10px" title="Aprovar" onclick="updateStatus('${data.id}', 'completed')"><i class="fa fa-check"></i></button>
                        <button class="btn btn-danger" style="padding:6px 10px" title="Rejeitar" onclick="updateStatus('${data.id}', 'rejected')"><i class="fa fa-times"></i></button>
                    </td>
                </tr>`;
            }).join('');
            
            document.getElementById('tb-orders').innerHTML = rows || '<tr><td colspan="6" style="text-align:center; padding:20px;">Nenhum pedido encontrado.</td></tr>';
        };

        window.updateStatus = async (id, newStatus) => {
            if(confirm(`Tem certeza que deseja marcar como ${newStatus === 'completed' ? 'Conclu√≠do' : 'Recusado'}?`)) {
                await updateDoc(doc(db, "orders", id), { status: newStatus });
                toast("Status do pedido atualizado!");
            }
        };

        onSnapshot(query(collection(db, "orders"), orderBy("date", "desc")), (snap) => {
            ordersList = [];
            let totalRev = 0, todayOrders = 0, rejCount = 0;
            const salesData = {};
            const today = new Date().toLocaleDateString();

            snap.docs.forEach(d => {
                const data = { id: d.id, ...d.data() };
                ordersList.push(data);

                const dateStr = new Date(data.date).toLocaleDateString();
                
                if(data.status === 'completed') {
                    totalRev += (data.total || 0);
                    salesData[dateStr] = (salesData[dateStr] || 0) + (data.total || 0);
                }
                if(data.status === 'rejected') rejCount++;
                if(dateStr === today) todayOrders++;
            });

            renderOrders();
            document.getElementById('st-revenue').innerText = totalRev.toLocaleString() + " MT";
            document.getElementById('st-orders-today').innerText = todayOrders;
            document.getElementById('st-orders-rej').innerText = rejCount;
            
            const sortedSales = Object.keys(salesData).sort().reduce((obj, key) => { obj[key] = salesData[key]; return obj; }, {});
            initChart(sortedSales);
        });

        // --- Usu√°rios ---
        onSnapshot(collection(db, "users"), (snap) => {
            // Atualiza card da dashboard
            document.getElementById('st-users').innerText = snap.size;
            
            // Renderiza tabela de usu√°rios
            usersList = snap.docs.map(d => ({id:d.id, ...d.data()}));
            renderUsers();
        });

        window.renderUsers = () => {
            document.getElementById('tb-users').innerHTML = usersList.map(u => {
                const wppLink = u.phone ? `https://wa.me/${u.phone.replace(/\D/g,'')}` : '#';
                const wppBtn = u.phone 
                    ? `<a href="${wppLink}" target="_blank" class="btn btn-success" style="padding:5px 8px; font-size:0.8rem;"><i class="fa-brands fa-whatsapp"></i></a>` 
                    : '<span style="color:#444">-</span>';

                return `<tr>
                    <td>${u.name || 'Sem nome'}</td>
                    <td style="color:var(--muted)">${u.email || '-'}</td>
                    <td>${u.phone || '-'}</td>
                    <td>${u.address || u.city || '-'}</td>
                    <td style="display:flex; gap:8px;">
                        ${wppBtn}
                        <button class="btn btn-danger" style="padding:5px 8px;" onclick="delItem('users', '${u.id}')"><i class="fa fa-trash"></i></button>
                    </td>
                </tr>`;
            }).join('') || '<tr><td colspan="5" style="text-align:center;">Nenhum usu√°rio encontrado.</td></tr>';
        };

        window.filterUsers = (val) => {
            const term = val.toLowerCase();
            const original = [...usersList];
            usersList = usersList.filter(u => (u.name && u.name.toLowerCase().includes(term)) || (u.email && u.email.toLowerCase().includes(term)));
            renderUsers();
            usersList = original; // Restaura lista completa para pr√≥xima busca
        };

        // --- Produtos ---
        document.getElementById('f-prod').onsubmit = async (e) => {
            e.preventDefault();
            const img1 = document.getElementById('pImg1').value;
            const img2 = document.getElementById('pImg2').value;
            
            try {
                await addDoc(collection(db, "products"), {
                    name: document.getElementById('pName').value,
                    price: Number(document.getElementById('pPrice').value),
                    cat: document.getElementById('pCat').value,
                    img: img1,
                    images: [img1, img2].filter(Boolean),
                    sizes: document.getElementById('pSizes').value.split(',').map(s=>s.trim()),
                    colors: document.getElementById('pColors').value.split(',').map(s=>s.trim()),
                    date: Date.now()
                });
                e.target.reset();
                toast("Produto publicado com sucesso!");
                toggleForm('prodForm');
            } catch(err) { toast("Erro ao salvar", "error"); }
        };

        onSnapshot(collection(db, "products"), (snap) => {
            productsList = snap.docs.map(d => ({id:d.id, ...d.data()}));
            renderProdTable(productsList);
        });

        window.renderProdTable = (list) => {
            document.getElementById('tb-prod').innerHTML = list.map(p => `
                <tr>
                    <td><img src="${p.img}" class="img-thumb"></td>
                    <td>${p.name}</td>
                    <td>${p.price} MT</td>
                    <td>${p.cat}</td>
                    <td><button class="btn btn-danger" onclick="delItem('products', '${p.id}')"><i class="fa fa-trash"></i></button></td>
                </tr>
            `).join('');
        };
        window.filterTable = (v) => renderProdTable(productsList.filter(p => p.name.toLowerCase().includes(v.toLowerCase())));

        // --- Categorias ---
        window.addCategory = async () => {
            const name = document.getElementById('catName').value;
            if(!name) return;
            const id = name.toLowerCase().replace(/\s+/g, '');
            await addDoc(collection(db, "categories"), { name, id });
            document.getElementById('catName').value = '';
            toast("Categoria criada!");
        };

        onSnapshot(collection(db, "categories"), snap => {
            let chips = '';
            let opts = '<option value="todos">Selecione...</option>';
            snap.docs.forEach(d => {
                const c = d.data();
                chips += `<div class="status-badge" style="background:#222; color:#fff; border:1px solid #444; padding:8px 15px; cursor:pointer; border-radius: 50px; font-size: 0.8rem;" onclick="delItem('categories', '${d.id}')">${c.name} <i class="fa fa-times" style="margin-left:5px; color:red;"></i></div>`;
                opts += `<option value="${c.id}">${c.name}</option>`;
            });
            document.getElementById('cat-chips').innerHTML = chips;
            document.getElementById('pCat').innerHTML = opts;
        });

        // --- Banners ---
        window.addBanner = async () => {
            const url = document.getElementById('bUrl').value;
            const link = document.getElementById('bLink').value;
            if(!url) return;
            await addDoc(collection(db, "banners"), { 
                url, 
                type: document.getElementById('bType').value,
                targetLink: link || ''
            });
            document.getElementById('bUrl').value = '';
            document.getElementById('bLink').value = '';
            toast("Banner adicionado!");
        };

        onSnapshot(collection(db, "banners"), snap => {
            document.getElementById('banner-list').innerHTML = snap.docs.map(d => {
                const data = d.data();
                return `
                <div style="position:relative; border:1px solid #333; border-radius:8px; overflow:hidden; animation: slideUp 0.3s ease;">
                    ${data.type === 'video' ? '<video src="'+data.url+'" style="width:100%; height:100px; object-fit:cover"></video>' : '<img src="'+data.url+'" style="width:100%; height:100px; object-fit:cover">'}
                    ${data.targetLink ? '<div style="position:absolute; bottom:0; left:0; width:100%; background:rgba(0,0,0,0.7); color:#fff; font-size:0.7rem; padding:3px 5px; text-overflow:ellipsis; white-space:nowrap; overflow:hidden;"><i class="fa fa-link"></i> '+data.targetLink+'</div>' : ''}
                    <button class="btn btn-danger" style="position:absolute; top:5px; right:5px; padding:5px 8px; font-size: 0.7rem;" onclick="delItem('banners', '${d.id}')"><i class="fa fa-trash"></i></button>
                </div>
            `}).join('');
        });

        // --- Configura√ß√µes ---
        window.saveConfig = async () => {
            await setDoc(doc(db, "settings", "store"), {
                whatsapp: document.getElementById('cWa').value,
                phone: document.getElementById('cPh').value,
                social: document.getElementById('cSocial').value,
                logo: document.getElementById('cLogo').value,
                appLink: document.getElementById('cAppLink').value,
                aboutText: document.getElementById('cAbout').value,
                deliveryText: document.getElementById('cDelivery').value
            }, { merge: true });
            toast("Loja atualizada com sucesso!");
        };

        onSnapshot(doc(db, "settings", "store"), s => {
            if(s.exists()) {
                const d = s.data();
                document.getElementById('cWa').value = d.whatsapp || '';
                document.getElementById('cPh').value = d.phone || '';
                document.getElementById('cSocial').value = d.social || '';
                document.getElementById('cLogo').value = d.logo || '';
                document.getElementById('cAppLink').value = d.appLink || '';
                document.getElementById('cAbout').value = d.aboutText || '';
                document.getElementById('cDelivery').value = d.deliveryText || '';
            }
        });

        window.delItem = (col, id) => {
            askDelete(async () => {
                await deleteDoc(doc(db, col, id));
                toast("Item exclu√≠do.", "success");
            });
        };
    </script>
</body>
</html>
